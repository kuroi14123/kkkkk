<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>J8b0000地震モニタ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body{margin:0;padding:0;background:#000;color:#fff;font-family:"Meiryo UI",sans-serif;overflow:hidden;}
  #map{width:100vw;height:100vh;position:fixed;top:0;left:0;}
  .leaflet-tile-pane{filter:brightness(0.38) contrast(1.35);}
  .leaflet-container{background:#000!important;}
  .status{position:absolute;top:15px;left:15px;padding:10px 25px;background:#001a00;border:2px solid #00ff00;border-radius:8px;font-size:17px;font-weight:bold;color:#00ff00;z-index:1000;}
  .eew-box{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:540px;background:#200000;border:9px solid #ff0000;border-radius:20px;padding:35px;text-align:center;z-index:2000;display:none;box-shadow:0 0 90px #f006;animation:blink 0.6s infinite;}
  @keyframes blink{0%,100%{opacity:1;}50%{opacity:0.7;}}
  .eew-int{font-size:130px;font-weight:bold;line-height:1;}
  .tsunami{position:absolute;top:15px;left:50%;transform:translateX(-50%);padding:14px 45px;background:#000033;border:5px solid #00ffff;border-radius:12px;font-size:25px;font-weight:bold;color:#00ffff;z-index:1001;display:none;animation:pulse 1s infinite;}
  @keyframes pulse{0%,100%{transform:translateX(-50%) scale(1);}50%{transform:translateX(-50%) scale(1.07);}}

  .scale{position:absolute;top:100px;left:15px;background:rgba(0,0,0,0.8);padding:14px 16px;border-radius:10px;z-index:10;font-size:14px;line-height:2.18;}
  .scale div{display:flex;align-items:center;gap:12px;margin:2px 0;}
  .scale span{width:27px;height:27px;display:inline-block;border-radius:5px;box-shadow:0 2px 6px rgba(0, 0, 0, 0.7);}
  .scale div:nth-child(1) span{background:#8b0000;} /* 震度7 & 6+ */
  .scale div:nth-child(2) span{background:#ff0000;}
  .scale div:nth-child(3) span{background:#ff4500;}
  .scale div:nth-child(4) span{background:#ffd700;}
  .scale div:nth-child(5) span{background:#ffff00;}
  .scale div:nth-child(6) span{background:#00ff00;}
  .scale div:nth-child(7) span{background:#00ffff;}
  .scale div:nth-child(8) span{background:#87cefa;}
  .scale div:nth-child(9) span{background:#5c5c5c;}

  .latest-box{position:absolute;top:15px;right:15px;width:400px;background:#111;border:1px solid #333;border-radius:10px;overflow:hidden;z-index:10;max-height:calc(100vh-30px);display:flex;flex-direction:column;box-shadow:0 4px 20px rgba(0,0,0,0.8);}
  .latest-title{background:linear-gradient(#0068b7,#0044a0);color:#fff;padding:12px;font-size:16px;font-weight:bold;text-align:center;}
  .latest-main{background:#000;padding:28px 20px;text-align:center;}
  .max-int{font-size:86px;font-weight:bold;line-height:1;}
  .int-label{font-size:14px;color:#fff;line-height:2.18;}
  .place-name{font-size:24px;margin:16px 0 10px;line-height:1.3;}
  .detail{font-size:18px;color:#ffffff;}
  .tsunami-info{color:#ff0000;font-size:20px;font-weight:bold;margin-top:15px;}
  .history-list{flex:1;overflow-y:auto;background:#0b0b0b;padding:6px 0;border-top:1px solid #222;}
  .history-item{padding:13px 18px;border-bottom:1px solid #222;cursor:pointer;transition:.2s;}
  .history-item:hover{background:#1a1a1a;}
  .history-item.active{background:#003366;color:#fff;font-weight:bold;}
  .clock{position:absolute;bottom:45px;right:20px;color:#888;font-size:14px;z-index:10;}
  .license{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:12px;color:#555;z-index:10;}
  .license a{color:#777;text-decoration:none;}

  .pure-number {
    background:transparent !important;border:none !important;box-shadow:none !important;
    color:#ffffff !important;font-size:19px !important;font-weight:900 !important;
    padding:0 !important;margin:0 !important;
  }
</style>
</head>
<body>
<div id="map"></div>

<div class="status">接続中…</div>
<div class="eew-box" id="eew">
  <div>緊急地震速報（第<span id="serial">1</span>報）</div>
  <div class="eew-int" id="eew-int">6+</div>
  <div id="eew-place">青森県東方沖</div>
  <div style="margin-top:18px;color:#ff8888;font-size:20px;">強い揺れに警戒してください</div>
</div>
<div class="tsunami" id="tsunami">津波警報・注意報 発表中！</div>

<div class="scale">
  <div><span></span>震度7</div>
  <div><span></span>震度6強</div>
  <div><span></span>震度6弱</div>
  <div><span></span>震度5強</div>
  <div><span></span>震度5弱</div>
  <div><span></span>震度4</div>
  <div><span></span>震度3</div>
  <div><span></span>震度2</div>
  <div><span></span>震度1</div>
</div>

<div class="latest-box">
  <div class="latest-title">最新地震情報</div>
  <div class="latest-main" id="latest">読み込み中…</div>
  <div class="history-list" id="list"></div>
</div>

<div class="clock" id="clock"></div>
<div class="license">データ提供：<a href="https://wolfx.jp/" target="_blank">Wolfx Open API</a> | 地図：© OpenStreetMap contributors</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map', {zoomControl:false, attributionControl:false, minZoom:4.8, maxZoom:10}).setView([36.5,138], 5.2);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
map.setMaxBounds([[20,122],[46,154]]);

let eqlist = [], markers = [];

// ここが最重要修正！「6+」も「7」も完全に真紅 #8b0000
function getColor(i) {
  if (i === '7' || i === '6+' || i === '6強以上' || i === '6+') return '#8b0000'; // ← 絶対に真紅
  if (i.includes('6強')) return '#8b0000';
  if (i.includes('6弱')) return '#ff4500';
  if (i.includes('5強')) return '#ffd700';
  if (i.includes('5弱')) return '#ffff00';
  if (i.includes('4')) return '#00ff00';
  if (i.includes('3')) return '#00ffff';
  if (i.includes('2')) return '#87cefa';
  return '#5c5c5c';
}

setInterval(() => document.getElementById('clock').textContent = new Date().toLocaleString('ja-JP').slice(0,19), 1000);

const ws = new WebSocket('wss://ws-api.wolfx.jp/all_eew');
ws.onopen = () => document.querySelector('.status').textContent = ' 接続成功';
ws.onclose = () => { document.querySelector('.status').textContent = '切断→再接続中…'; setTimeout(() => location.reload(), 5000); };

ws.onmessage = e => {
  try {
    const d = JSON.parse(e.data);
    if (d.type !== 'jma_eew' || d.isCancel || d.isTraining) return;
    const int = d.MaxIntensity || '不明';
    if (int === '不明') return;

    document.getElementById('eew').style.display = 'block';
    document.getElementById('serial').textContent = d.Serial || 1;
    document.getElementById('eew-int').textContent = int;
    document.getElementById('eew-int').style.color = getColor(int);  // ← 6+も真紅に！
    document.getElementById('eew-place').textContent = (d.WarnArea?.Chiiki || d.Hypocenter || '各地') + 'で強い揺れ';

    if (d.Latitude && d.Longitude) {
      map.eachLayer(l => { if (l.options && l.options.radius === 22) map.removeLayer(l); });
      L.circleMarker([d.Latitude, d.Longitude], {radius:22, color:'#ff0000', weight:8, fillOpacity:0.9})
        .addTo(map)
        .bindTooltip("EEW", {permanent:true, direction:'center', className:'pure-number'})
        .openTooltip();
      map.setView([d.Latitude, d.Longitude], 7, {animate:true});
    }
    if (d.isFinal) setTimeout(() => document.getElementById('eew').style.display='none', 18000);
  } catch(e) {}
};

function updateMap() {
  markers.forEach(m => map.removeLayer(m)); markers = [];
  eqlist.slice(0,40).forEach(e => {
    if (e.lat && e.lng) {
      const radius = Math.max(9, 9 + parseInt(e.int || 1) * 1.2);
      const marker = L.circleMarker([e.lat, e.lng], {
        radius: radius,
        color: getColor(e.int),           // ← 6+も #8b0000
        weight: 3,
        fillColor: getColor(e.int),
        fillOpacity: 0.75
      }).addTo(map);

      marker.bindTooltip(e.int, {
        permanent: true,
        direction: 'center',
        className: 'pure-number'
      }).openTooltip();

      markers.push(marker);
    }
  });
}

async function update() {
  try {
    const r = await fetch('https://api.wolfx.jp/jma_eqlist.json');
    const d = await r.json();
    eqlist = []; let tsunami = false;
    for (let i = 1; i <= 50; i++) {
      const ee = d[`No${i}`];
      if (ee && ee.shindo !== '不明') {
        const hasT = (ee.info||'').includes('津波') && !(ee.info||'').includes('心配はありません');
        if (hasT) tsunami = true;
        eqlist.push({
          int: ee.shindo,
          area: ee.location || '調査中',
          time: ee.time || ee.time_full,
          mag: ee.magnitude ? parseFloat(ee.magnitude) : null,
          depth: ee.depth || '調査中',
          lat: parseFloat(ee.latitude),
          lng: parseFloat(ee.longitude),
          tsunami: hasT ? '警報' : 'なし'
        });
      }
    }
    eqlist.sort((a,b) => new Date(b.time) - new Date(a.time));
    document.getElementById('tsunami').style.display = tsunami ? 'block' : 'none';
    render(); updateMap();
  } catch(e) {}
}

function render() {
  if (!eqlist.length) {
    document.getElementById('latest').innerHTML = '<div style="color:#aaa;padding:90px 0;font-size:19px;">現在、震度1以上の地震はありません</div>';
    document.getElementById('list').innerHTML = '';
    return;
  }
  const e = eqlist[0];
  document.getElementById('latest').innerHTML = `
    <div class="max-int" style="color:${getColor(e.int)}">${e.int}</div>
    <div class="int-label">最大震度</div>
    <div class="place-name">${e.area}</div>
    <div class="detail">${e.time.slice(5,16)} 発生</div>
    <div class="detail" style="margin-top:20px;color:#aaa;">M${e.mag?.toFixed(1)||'-.-'}　深さ${e.depth}</div>
    ${e.tsunami==='警報'?'<div class="tsunami-info">津波警報・注意報 発表中！</div>':''}
  `;
  document.getElementById('list').innerHTML = eqlist.slice(0,30).map((e,i) => `
    <div class="history-item ${i===0?'active':''}" onclick="sel(${i})">
      <div style="color:#aaa;font-size:13px;">${e.time.slice(5,16)}</div>
      <div style="color:${getColor(e.int)};font-size:21px;font-weight:bold;">${e.int}</div>
      <div style="font-size:15px;color:#ddd;">${e.area}</div>
      <div style="font-size:13px;color:#888;">M${e.mag?.toFixed(1)||'-.-'}　津波:${e.tsunami}</div>
    </div>
  `).join('');
}

function sel(i) {
  const e = eqlist[i];
  document.getElementById('latest').innerHTML = `
    <div class="max-int" style="color:${getColor(e.int)}">${e.int}</div>
    <div class="int-label">最大震度</div>
    <div class="place-name">${e.area}</div>
    <div class="detail">${e.time.slice(5,16)} 発生</div>
    <div class="detail" style="margin-top:20px;color:#aaa;">M${e.mag?.toFixed(1)||'-.-'}　深さ${e.depth}</div>
    ${e.tsunami==='警報'?'<div class="tsunami-info">津波警報・注意報 発表中！</div>':''}
  `;
  map.flyTo([e.lat, e.lng], 8);
  document.querySelectorAll('.history-item').forEach((el,j) => el.classList.toggle('active', j===i));
}

update();
setInterval(update, 10000);
</script>
</body>
</html>
