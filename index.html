<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>地震情報｜tenki.jp 完全再現 2025.11.30 過去20時間対応版</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body{margin:0;padding:0;background:#000;color:#fff;font-family:"Meiryo UI",sans-serif;overflow:hidden;}
  #map{width:100vw;height:100vh;position:fixed;top:0;left:0;}
  .leaflet-tile-pane{filter:brightness(0.38) contrast(1.35);}
  .leaflet-container{background:#000!important;}
  .eeew-status{
    position:absolute;top:15px;left:15px;padding:12px 28px;
    background:#001a00;border:2px solid #00ff00;border-radius:8px;
    font-size:18px;font-weight:bold;color:#00ff00;z-index:1000;
  }
  .scale{
    position:absolute;top:100px;left:15px;background:rgba(0,0,0,0.8);padding:15px 12px;
    border-radius:10px;z-index:10;font-size:14px;line-height:2.1;
  }
  .scale div{display:flex;align-items:center;gap:10px;}
  .scale span{width:24px;height:24px;display:inline-block;border-radius:4px;}
  .latest-box{
    position:absolute;top:15px;right:15px;width:400px;background:#111;
    border:1px solid #000;border-radius:10px;overflow:hidden;z-index:10;
    max-height:calc(100vh - 30px);display:flex;flex-direction:column;
  }
  .latest-title{
    background:linear-gradient(to bottom,#0068b7,#0044a0);
    color:#fff;padding:10px 15px;font-size:16px;font-weight:bold;text-align:center;flex-shrink:0;
  }
  .latest-main{
    background:#000;padding:25px 20px;text-align:center;flex-shrink:0;
  }
  .max-int{font-size:82px;font-weight:bold;line-height:1;}
  .int-label{font-size:20px;color:#fff;margin-top:5px;}
  .place-name{font-size:23px;color:#fff;margin-top:12px;line-height:1.3;}
  .detail{font-size:18px;color:#ccc;margin-top:10px;}
  .history-list{
    flex:1;overflow-y:auto;background:#0a0a0a;padding:8px 0;
    border-top:1px solid #222;
  }
  .history-item{
    padding:12px 18px;border-bottom:1px solid #222;cursor:pointer;transition:0.2s;
  }
  .history-item:hover{background:#1a1a1a;}
  .history-item.active{background:#003366;color:#fff;}
  .hist-time{color:#aaa;font-size:13px;}
  .hist-int{font-size:20px;font-weight:bold;margin:4px 0;}
  .hist-place{font-size:15px;color:#ddd;}
  .hist-mag{font-size:13px;color:#888;margin-top:4px;}
  .clock{position:absolute;bottom:15px;right:20px;color:#888;font-size:14px;z-index:10;}
  @keyframes blink{0%,100%{opacity:1;}50%{opacity:0.5;}}
</style>
</head>
<body>
<div id="map"></div>

<div class="eeew-status" id="eeew-status">
  緊急地震速報は発表されていません
</div>

<div class="scale">
  <div><span style="background:#8b0000"></span>震度7</div>
  <div><span style="background:#ff0000"></span>震度6強</div>
  <div><span style="background:#ff4500"></span>震度6弱</div>
  <div><span style="background:#ffd700"></span>震度5強</div>
  <div><span style="background:#ffff00"></span>震度5弱</div>
  <div><span style="background:#00ff00"></span>震度4</div>
  <div><span style="background:#00ffff"></span>震度3</div>
  <div><span style="background:#87cefa"></span>震度2</div>
  <div><span style="background:#ffffff"></span>震度1</div>
</div>

<div class="latest-box">
  <div class="latest-title">最新地震情報</div>
  <div class="latest-main" id="latest-main">読み込み中…</div>
  <div class="history-list" id="history-list"></div>
</div>

<div class="clock" id="clock"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map',{zoomControl:false,attributionControl:false,minZoom:4.8,maxZoom:10}).setView([36.5,138],5.2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:''}).addTo(map);
map.setMaxBounds([[24,122],[46,154]]);

setInterval(()=>document.getElementById('clock').textContent=new Date().toLocaleString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}),500);

function scaleToText(s){
  if(!s && s!==0) return "−";
  const n = Math.round(s/10);
  return n===7?"7":n===6?"6強":n===5?"6弱":n===4?"5強":n===3?"5弱":n===2?"4":n===1?"3":n===0?"1":"−";
}

function formatTime(ts){
  const d = new Date(ts);
  if(isNaN(d)) return '不明';
  const now = new Date();
  const diff = now - d;
  if(diff < 3600000) return Math.floor(diff/60000) + '分前';
  if(diff < 86400000) return Math.floor(diff/3600000) + '時間前';
  return d.toLocaleString('ja-JP').slice(5,16).replace('/', '月').replace(' ', '日 ');
}

const PROXIES = [
  'https://api.allorigins.win/raw?url=',
  'https://corsproxy.io/?',
  'https://thingproxy.freeboard.io/fetch/'
];

async function fetchJSON(url){
  for(let p of PROXIES){
    try{
      const r = await fetch(p + encodeURIComponent(url),{cache:"no-store"});
      if(r.ok) return await r.json();
    }catch(e){}
  }
  throw new Error("全プロキシ失敗");
}

let recentEarthquakes = [];

async function loadHistory(){
  try{
    const data = await fetchJSON('https://api.p2pquake.net/v2/history?codes=551&limit=100');
    const cutoff = Date.now() - 20*60*60*1000;
    recentEarthquakes = data
      .filter(d => d.earthquake && new Date(d.earthquake.time).getTime() >= cutoff)
      .sort((a,b) => new Date(b.earthquake.time) - new Date(a.earthquake.time));
    renderAll();
  }catch(e){
    document.getElementById('latest-main').innerHTML = '<div style="color:#fcc;padding:30px 0;font-size:16px;">通信エラー<br>再読み込み中…</div>';
  }
}

function renderAll(){
  if(recentEarthquakes.length === 0){
    document.getElementById('latest-main').innerHTML = '<div style="color:#aaa;padding:50px 0;font-size:18px;">過去20時間に震度1以上の地震はありません</div>';
    document.getElementById('history-list').innerHTML = '';
    return;
  }

  const latest = recentEarthquakes[0].earthquake;
  const maxInt = latest.maxScale || 0;
  const color = {70:"#8b0000",60:"#ff0000",55:"#ff0000",50:"#ff4500",45:"#ff4500",40:"#ffd700",30:"#ffff00",20:"#ffff00",10:"#00ff00",0:"#ccc"}[Math.floor(maxInt/10)*10]||"#ccc";

  document.getElementById('latest-main').innerHTML = `
    <div class="max-int" style="color:${color}">${scaleToText(maxInt)}</div>
    <div class="int-label">最大震度</div>
    <div class="place-name">${latest.hypocenter?.name || "調査中"}</div>
    <div class="detail">${formatTime(latest.time)} 発生</div>
    <div class="detail" style="margin-top:18px;font-size:16px;color:#aaa;">
      M${latest.magnitude?.toFixed(1)||"-.-"}　深さ${latest.depth?latest.depth+"km":"調査中"}
    </div>
  `;

  // 過去地震リスト
  const listHTML = recentEarthquakes.map((item,i) => {
    const eq = item.earthquake;
    const isLatest = i===0;
    return `
      <div class="history-item ${isLatest?'active':''}" onclick="selectEarthquake(${i})">
        <div class="hist-time">${formatTime(eq.time)}</div>
        <div class="hist-int" style="color:${colorTable(eq.maxScale)}">${scaleToText(eq.maxScale)}</div>
        <div class="hist-place">${eq.hypocenter?.name || "調査中"}</div>
        <div class="hist-mag">M${eq.magnitude?.toFixed(1)||"-.-"}　${eq.depth?eq.depth+"km":"-"}</div>
      </div>
    `;
  }).join('');

  document.getElementById('history-list').innerHTML = listHTML;
}

function colorTable(scale){
  const t = {70:"#8b0000",60:"#ff0000",55:"#ff0000",50:"#ff4500",45:"#ff4500",40:"#ffd700",30:"#ffff00",20:"#ffff00",10:"#00ff00"}[Math.floor((scale||0)/10)*10];
  return t||"#aaa";
}

function selectEarthquake(index){
  const item = recentEarthquakes[index].earthquake;
  const maxInt = item.maxScale || 0;
  const color = colorTable(maxInt);
  document.getElementById('latest-main').innerHTML = `
    <div class="max-int" style="color:${color}">${scaleToText(maxInt)}</div>
    <div class="int-label">最大震度</div>
    <div class="place-name">${item.hypocenter?.name || "調査中"}</div>
    <div class="detail">${formatTime(item.time)} 発生</div>
    <div class="detail" style="margin-top:18px;font-size:16px;color:#aaa;">
      M${item.magnitude?.toFixed(1)||"-.-"}　深さ${item.depth?item.depth+"km":"調査中"}
    </div>
  `;
  document.querySelectorAll('.history-item').forEach((el,j)=>el.classList.toggle('active', j===index));
}

// 初期読み込み
loadHistory();
setInterval(loadHistory, 30000);

// WebSocketリアルタイム
const ws = new WebSocket('wss://api.p2pquake.net/v2/ws');
ws.onmessage = e => {
  const d = JSON.parse(e.data);
  if(d.test) return;

  if(d.code === 554 || (d.issue?.type==="EarthquakeEarlyWarning" && !d.canceled)){
    const s = document.getElementById('eeew-status');
    s.textContent = "緊急地震速報（警報）";
    s.style.cssText = "background:#330000!important;border:3px solid #ff0000!important;color:#ff0000!important;animation:blink 0.7s infinite;box-shadow:0 0 30px #f00;";
    new Audio('https://www.nhk.or.jp/radio/player/alert.mp3').play().catch(()=>{});
  }

  if(d.code === 551 && d.earthquake){
    loadHistory(); // 最新リストごと更新
  }
};
</script>
</body>
</html>
