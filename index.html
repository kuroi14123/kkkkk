<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>強震モニタtestversion</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body{margin:0;padding:0;background:#000;color:#fff;font-family:"Meiryo UI",sans-serif;overflow:hidden;}
  #map{width:100vw;height:100vh;position:fixed;top:0;left:0;}
  .leaflet-tile-pane{filter:brightness(0.38) contrast(1.35);}
  .leaflet-container{background:#000!important;}
  .eeew-status{position:absolute;top:15px;left:15px;padding:12px 28px;background:#001a00;border:2px solid #00ff00;border-radius:8px;font-size:18px;font-weight:bold;color:#00ff00;z-index:1000;}
  .scale{position:absolute;top:100px;left:15px;background:rgba(0,0,0,0.8);padding:15px 12px;border-radius:10px;z-index:10;font-size:14px;line-height:2.1;}
  .scale div{display:flex;align-items:center;gap:10px;}
  .scale span{width:24px;height:24px;display:inline-block;border-radius:4px;}
  .latest-box{position:absolute;top:15px;right:15px;width:400px;background:#111;border:1px solid #000;border-radius:10px;overflow:hidden;z-index:10;max-height:calc(100vh-30px);display:flex;flex-direction:column;box-shadow:0 4px 20px rgba(0,0,0,0.8);}
  .latest-title{background:linear-gradient(to bottom,#0068b7,#0044a0);color:#fff;padding:12px 15px;font-size:16px;font-weight:bold;text-align:center;flex-shrink:0;}
  .latest-main{background:#000;padding:28px 20px;text-align:center;flex-shrink:0;}
  .max-int{font-size:86px;font-weight:bold;line-height:1;}
  .int-label{font-size:21px;color:#fff;margin-top:6px;}
  .place-name{font-size:24px;color:#fff;margin-top:14px;line-height:1.3;}
  .detail{font-size:18px;color:#ccc;margin-top:10px;}
  .history-list{flex:1;overflow-y:auto;background:#0b0b0b;padding:6px 0;border-top:1px solid #222;}
  .history-item{padding:13px 18px;border-bottom:1px solid #222;cursor:pointer;transition:.2s;}
  .history-item:hover{background:#1a1a1a;}
  .history-item.active{background:#003366;color:#fff;font-weight:bold;}
  .hist-time{color:#aaa;font-size:13px;}
  .hist-int{font-size:21px;font-weight:bold;margin:5px 0;}
  .hist-place{font-size:15px;color:#ddd;}
  .hist-mag{font-size:13px;color:#888;margin-top:4px;}
  .clock{position:absolute;bottom:15px;right:20px;color:#888;font-size:14px;z-index:10;}
</style>
</head>
<body>
<div id="map"></div>
<div class="eeew-status">Wolfx Open API 稼働中</div>
<div class="scale">
  <div><span style="background:#8b0000"></span>震度7</div>
  <div><span style="background:#ff0000"></span>震度6強</div>
  <div><span style="background:#ff4500"></span>震度6弱</div>
  <div><span style="background:#ffd700"></span>震度5強</div>
  <div><span style="background:#ffff00"></span>震度5弱</div>
  <div><span style="background:#00ff00"></span>震度4</div>
  <div><span style="background:#00ffff"></span>震度3</div>
  <div><span style="background:#87cefa"></span>震度2</div>
  <div><span style="background:#ffffff"></span>震度1</div>
</div>

<div class="latest-box">
  <div class="latest-title">最新地震情報（Wolfx）</div>
  <div class="latest-main" id="latest-main">読み込み中…</div>
  <div class="history-list" id="history-list"></div>
</div>

<div class="clock" id="clock"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map',{zoomControl:false,attributionControl:false,minZoom:4.8,maxZoom:10}).setView([36.5,138],5.2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
map.setMaxBounds([[24,122],[46,154]]);

let earthquakes = [], markers = [];

setInterval(()=>document.getElementById('clock').textContent=new Date().toLocaleString('ja-JP').slice(0,19),1000);

function formatTime(ts){
  // Wolfxのtime形式対応: "2025/11/30 20:25" → ISO形式に変換
  const match = ts.match(/(\d{4})\/(\d{2})\/(\d{2})\s+(\d{2}):(\d{2})/);
  if(match){
    const iso = `${match[1]}-${match[2]}-${match[3]}T${match[4]}:${match[5]}:00`;
    const d = new Date(iso);
    return d.toLocaleString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).replace(/\//g,'/');
  }
  return ts; // フォールバック
}

function scaleToText(shindo){
  if(shindo === '不明' || !shindo) return "−";
  // Wolfx APIのshindo形式: 数字のみ ("1","2","3","4") を直接使用
  // 弱/強はAPIデータにないため、数字をそのまま表示 (例: "3" → "3")
  const num = parseInt(shindo);
  if(isNaN(num)) return "−";
  return num.toString();
}

function getColor(intensity){
  // 数字のみのintensityに対応 (1-7)
  const num = parseInt(intensity);
  if(isNaN(num)) return "#ccc";
  const map = {7:"#8b0000",6:"#ff0000",5:"#ff4500",4:"#ffd700",3:"#ffff00",2:"#ffff00",1:"#00ff00"};
  return map[num] || "#00ff00";
}

// Wolfx Open API のみ使用 (jma_eqlist.json)
async function loadData(){
  try{
    const res = await fetch('https://api.wolfx.jp/jma_eqlist.json');
    const data = await res.json();

    // No1 ~ No50 を抽出、shindoが"不明"でないものだけ（震度1以上相当）
    earthquakes = [];
    for(let i=1; i<=50; i++){
      const key = `No${i}`;
      const eq = data[key];
      if(eq && eq.shindo !== '不明' && eq.shindo !== undefined){
        const intensity = scaleToText(eq.shindo);
        if(intensity !== "−"){
          earthquakes.push({
            intensity,
            area: eq.location || "調査中",
            time: eq.time || eq.time_full || new Date().toISOString(),
            magnitude: eq.magnitude ? parseFloat(eq.magnitude) : null,
            depth: eq.depth ? eq.depth.replace('km', '') : "調査中",
            lat: parseFloat(eq.latitude),
            lng: parseFloat(eq.longitude)
          });
        }
      }
    }

    earthquakes.sort((a,b) => new Date(b.time) - new Date(a.time));

    render();
    updateMarkers();
    console.log('Wolfx API 取得成功：' + earthquakes.length + '件');
  }catch(e){
    console.error('Wolfx API失敗', e);
    document.getElementById('latest-main').innerHTML = '<div style="color:#aaa;padding:60px 0;">データ取得失敗<br>Wolfx APIが応答しません</div>';
  }
}

function updateMarkers(){
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  earthquakes.slice(0,30).forEach(eq => {
    if(eq.lat && eq.lng && !isNaN(eq.lat) && !isNaN(eq.lng)){
      const num = parseInt(eq.intensity) || 1;
      const marker = L.circleMarker([eq.lat, eq.lng], {
        radius: 8 + num,
        color: getColor(eq.intensity),
        weight: 3,
        fillOpacity: 0.8
      }).addTo(map)
      .bindPopup(`${eq.area}<br>震度${eq.intensity}<br>${formatTime(eq.time)}`);
      markers.push(marker);
    }
  });
}

function render(){
  if(earthquakes.length === 0){
    document.getElementById('latest-main').innerHTML = '<div style="color:#aaa;padding:60px 0;font-size:19px;">現在、震度1以上の地震はありません</div>';
    document.getElementById('history-list').innerHTML = '';
    return;
  }

  const e = earthquakes[0];
  document.getElementById('latest-main').innerHTML = `
    <div class="max-int" style="color:${getColor(e.intensity)}">${e.intensity}</div>
    <div class="int-label">最大震度</div>
    <div class="place-name">${e.area}</div>
    <div class="detail">${formatTime(e.time)} 発生</div>
    <div class="detail" style="margin-top:20px;font-size:17px;color:#aaa;">
      M${e.magnitude ? e.magnitude.toFixed(1) : "-.-"}　深さ${e.depth}
    </div>
  `;

  document.getElementById('history-list').innerHTML = earthquakes.slice(0,30).map((eq,i) => `
    <div class="history-item ${i===0?'active':''}" onclick="selectEq(${i})">
      <div class="hist-time">${formatTime(eq.time)}</div>
      <div class="hist-int" style="color:${getColor(eq.intensity)}">${eq.intensity}</div>
      <div class="hist-place">${eq.area}</div>
      <div class="hist-mag">M${eq.magnitude ? eq.magnitude.toFixed(1) : "-.-"}　${eq.depth}</div>
    </div>
  `).join('');
}

function selectEq(i){
  const e = earthquakes[i];
  document.getElementById('latest-main').innerHTML = `
    <div class="max-int" style="color:${getColor(e.intensity)}">${e.intensity}</div>
    <div class="int-label">最大震度</div>
    <div class="place-name">${e.area}</div>
    <div class="detail">${formatTime(e.time)} 発生</div>
    <div class="detail" style="margin-top:20px;font-size:17px;color:#aaa;">
      M${e.magnitude ? e.magnitude.toFixed(1) : "-.-"}　深さ${e.depth}
    </div>
  `;
  if(e.lat && e.lng) map.flyTo([e.lat, e.lng], 8);
  document.querySelectorAll('.history-item').forEach((el,j)=>el.classList.toggle('active',j===i));
}

// 8秒ごとに更新
setInterval(loadData, 8000);
loadData(); // 初回読み込み
</script>
</body>
</html>
