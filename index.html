<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>地震情報｜tenki.jp 完全再現 2025.11.29 最新仕様</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body{margin:0;padding:0;background:#000;color:#fff;font-family:"Meiryo UI",sans-serif;overflow:hidden;}
  #map{width:100vw;height:100vh;position:fixed;top:0;left:0;}
  .leaflet-tile-pane{filter:brightness(0.38) contrast(1.35);}
  .leaflet-container{background:#000!important;}

  /* 左上：緊急地震速報 */
  .eeew-status{
    position:absolute;top:15px;left:15px;padding:12px 28px;
    background:#001a00;border:2px solid #00ff00;border-radius:8px;
    font-size:18px;font-weight:bold;color:#00ff00;z-index:1000;
    box-shadow:0 0 20px rgba(0, 255, 0, 0);
  }

  /* 震度スケール */
  .scale{
    position:absolute;top:100px;left:15px;background:rgba(0, 0, 0, 0.8);padding:15px 12px;
    border-radius:10px;z-index:10;font-size:14px;line-height:2.1;
  }
  .scale div{display:flex;align-items:center;gap:10px;}
  .scale span{width:24px;height:24px;display:inline-block;border-radius:4px;}

  /* 右上：最新地震情報 → 最大震度デカ表示（本物と同じ） */
  .latest-box{
    position:absolute;top:15px;right:15px;width:380px;background:#111;
    border:1px solid #000000;border-radius:10px;overflow:hidden;z-index:10;
  }
  .latest-title{
    background:linear-gradient(to bottom,#0068b7,#0044a0);
    color:#fff;padding:10px 15px;font-size:16px;font-weight:bold;text-align:center;
  }
  .latest-content{
    padding:25px 20px;background:#000;text-align:center;
  }
  .max-int{font-size:78px;font-weight:bold;color:#ffffff;line-height:1;}
  .int-label{font-size:20px;color:#fff;margin-top:5px;}
  .place-name{font-size:22px;color:#fff;margin-top:12px;line-height:1.3;}
  .detail{font-size:18px;color:#ccc;margin-top:10px;}

  .clock{position:absolute;bottom:15px;right:20px;color:#888;font-size:14px;z-index:10;}
  @keyframes blink{0%,100%{opacity:1;}50%{opacity:0.5;}}
</style>
</head>
<body>

<div id="map"></div>

<div class="eeew-status" id="eeew-status">
  緊急地震速報は発表されていません
</div>

<div class="scale">
  <div><span style="background:#8b0000"></span>震度7</div>
  <div><span style="background:#ff0000"></span>震度6強</div>
  <div><span style="background:#ff4500"></span>震度6弱</div>
  <div><span style="background:#ffd700"></span>震度5強</div>
  <div><span style="background:#ffff00"></span>震度5弱</div>
  <div><span style="background:#00ff00"></span>震度4</div>
  <div><span style="background:#00ffff"></span>震度3</div>
  <div><span style="background:#87cefa"></span>震度2</div>
  <div><span style="background:#ffffff"></span>震度1</div>
</div>

<!-- 右上：最新地震情報（最大震度デカ表示） -->
<div class="latest-box">
  <div class="latest-title">最新地震情報</div>
  <div class="latest-content" id="latest-content">
    読み込み中…
  </div>
</div>

<div class="clock" id="clock"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map',{zoomControl:false,attributionControl:false,minZoom:4.8,maxZoom:10}).setView([36.5,138],5.2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:''}).addTo(map);
map.setMaxBounds([[24,122],[46,154]]);

setInterval(()=>document.getElementById('clock').textContent=new Date().toLocaleString('ja-JP').slice(0,19).replace(/\/(\d\d\/)/g,'/$1'),500);

function scaleToText(s){
  if(!s) return "調査中";
  const n = Math.round(s/10);
  return n===7?"7":n===6?"6強":n===5?"6弱":n===4?"5強":n===3?"5弱":n===2?"4":n===1?"3":n<=0?"1":"震度"+n;
}

const HISTORY_HOURS = 20;
function formatTime(ts){
  const d = new Date(ts);
  if(isNaN(d)) return '日時不明';
  // ロケール形式で先頭19文字（YYYY/MM/DD hh:mm:ss 相当）を返す
  return d.toLocaleString('ja-JP').slice(0,19);
}
function renderLatest(events){
  if(!events || events.length===0){
    document.getElementById('latest-content').textContent = '過去20時間の地震情報はありません';
    return;
  }
  // 時刻降順にソート
  const sorted = events.slice().sort((a,b)=>{
    const ta = new Date(a.time || a.earthquake?.time || a.issue?.time).getTime();
    const tb = new Date(b.time || b.earthquake?.time || b.issue?.time).getTime();
    return tb - ta;
  });

  const main = sorted[0].earthquake ? sorted[0].earthquake : sorted[0];
  const h = main.hypocenter || main;
  const int = scaleToText(main.maxScale);
  const mag = (h.magnitude ?? main.magnitude ?? 0).toFixed ? ( (h.magnitude ?? main.magnitude ?? 0).toFixed(1) ) : '不明';
  const depth = h.depth ?? main.depth ?? '不明';

  let html = `\n    <div class="max-int">${int}</div>\n    <div class="int-label">最大震度</div>\n    <div class="place-name">${h.name || '調査中'}</div>\n    <div class="detail">M${mag}　深さ約${depth}km</div>`;

  html += `<div style="margin-top:12px;text-align:left;max-height:220px;overflow:auto;padding:8px 6px;background:rgba(255,255,255,0.02);border-radius:6px;">`;

  sorted.forEach(ev=>{
    const t = ev.time || ev.earthquake?.time || ev.issue?.time;
    const qq = ev.earthquake ? ev.earthquake : ev;
    const hh = qq.hypocenter || {};
    const s = scaleToText(qq.maxScale);
    const place = hh.name || '調査中';
    const m = (hh.magnitude ?? qq.magnitude ?? 0).toFixed ? ((hh.magnitude ?? qq.magnitude ?? 0).toFixed(1)) : '不明';
    html += `<div style="border-bottom:1px solid rgba(255,255,255,0.04);padding:8px 0;font-size:13px;color:#ddd;">`+
            `<div style="color:#9aa;padding-bottom:2px;">${(new Date(t)).toLocaleString('ja-JP').slice(0,19).replace(/\/(\d\d\/) /g,'/$1')}</div>`+
            `<div style="font-weight:600;color:#fff;">${place}<span style=\"float:right;color:#fff;\">${s}  M${m}</span></div>`+
            `</div>`;
  });

  html += `</div>`;
  document.getElementById('latest-content').innerHTML = html;
}

function fetchHistoryAndRender(){
  // 読み込み中表示を出しておく
  document.getElementById('latest-content').textContent = '読み込み中…';
  fetch('https://api.p2pquake.net/v2/history?codes=551&limit=200')
    .then(r=>{
      if(!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(d=>{
      const now = Date.now();
      const cutoff = now - HISTORY_HOURS * 3600 * 1000;
      const filtered = d.filter(ev=>{
        const t = new Date(ev.time || ev.earthquake?.time || ev.issue?.time).getTime();
        return !isNaN(t) && t >= cutoff;
      });
      renderLatest(filtered);
    }).catch(err=>{
      console.error('fetchHistoryAndRender error:', err);
      // エラー時にユーザー向けメッセージを表示
      document.getElementById('latest-content').textContent = 'データ取得に失敗しました。ブラウザのコンソールを確認するか、ファイルを直接開いている場合はローカルサーバーで配信してから再読み込みしてください。';
    });
}

// 初期表示
fetchHistoryAndRender();

// リアルタイム更新
const ws = new WebSocket('wss://api.p2pquake.net/v2/ws');
ws.onmessage = e => {
  const d = JSON.parse(e.data);
  if(d.issue && (d.issue.type==="Test"||d.test)) return;

  if(d.issue?.type==="EarthquakeEarlyWarning" && !d.canceled){
    const s = document.getElementById('eeew-status');
    s.textContent = "緊急地震速報（警報）";
    s.style.cssText = "background:#330000!important;border:3px solid #ff0000!important;color:#ff0000!important;animation:blink 0.7s infinite;box-shadow:0 0 30px #f00;";
    new Audio('https://www.nhk.or.jp/radio/player/alert.mp3').play().catch(()=>{});
  }

  if(d.code===551 && d.earthquake){
    // 履歴を再取得して表示を更新
    fetchHistoryAndRender();
  }
};

ws.onerror = e => {
  console.error('WebSocket error', e);
  document.getElementById('eeew-status').textContent = 'リアルタイム接続に問題があります';
};
ws.onclose = e => {
  console.warn('WebSocket closed', e);
  // 切断時は履歴を再取得して表示状態を確保
  fetchHistoryAndRender();
};
</script>
</body>
</html>
